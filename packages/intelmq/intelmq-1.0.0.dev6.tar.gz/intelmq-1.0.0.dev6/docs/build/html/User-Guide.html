<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>} &mdash; Python  documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Python  documentation" href="contents.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p># User Guide</p>
<blockquote>
<div><ul>
<li><p class="first">[Requirements](#requirements)</p>
</li>
<li><p class="first">[Install](#install)
* [Install Dependencies](#install-dependencies)</p>
<blockquote>
<div><ul class="simple">
<li>[Python 3.4 (recommended)](#python-34-recommended)
* [Ubuntu 14.04 / Debian 8](#ubuntu-1404&#8211;debian-8)
* [CentOS 7](#centos-7)</li>
<li>[Python 2.7](#python-27)
* [Ubuntu 14.04 / Debian 8](#ubuntu-1404&#8211;debian-8-1)
* [CentOS 7](#centos-7-1)</li>
</ul>
</div></blockquote>
<ul>
<li><dl class="first docutils">
<dt>[Install](#install-1)</dt>
<dd><ul class="first last simple">
<li>[Python 3.4 (recommended)](#python-34-recommended-1)</li>
<li>[Python 2.7](#python-27-1)</li>
</ul>
</dd>
</dl>
</li>
</ul>
</li>
<li><p class="first">[Configuration](#configuration)
* [System Configuration](#system-configuration)
* [Startup Configuration](#startup-configuration)
* [Pipeline Configuration](#pipeline-configuration)
* [Defaults Configuration](#defaults-configuration)</p>
<blockquote>
<div><ul class="simple">
<li>[Error Handling](#error-handling)</li>
<li>[Miscellaneous](#miscellaneous)</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>[Runtime Configuration](#runtime-configuration)</li>
<li>[Harmonization Configuration](#harmonization-configuration)</li>
</ul>
</li>
<li><p class="first">[Utilities](#utilities)
* [Management](#management)</p>
<blockquote>
<div><ul class="simple">
<li>[Web interface: IntelMQ Manager](#web-interface-intelmq-manager)</li>
<li>[Command-line interface: intelmqctl](#command-line-interface-intelmqctl)
* [Botnet Concept](#botnet-concept)
* [Start bots with non-default Python](#start-bots-with-non-default-python)
* [Forcing reset pipeline and cache (be careful)](#forcing-reset-pipeline-and-cache-be-careful)</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>[Error Handling](#error-handling-1)
* [Tool: intelmqdump](#tool-intelmqdump)</li>
<li>[Monitoring Logs](#monitoring-logs)</li>
</ul>
</li>
<li><p class="first">[Upgrade](#upgrade)
* [Stop IntelMQ and Backup](#stop-intelmq-and-backup)
* [Upgrade](#upgrade-1)
* [Restore Configurations](#restore-configurations)</p>
</li>
<li><p class="first">[Uninstall](#uninstall)</p>
</li>
<li><p class="first">[Frequently Asked Questions](#frequently-asked-questions)</p>
</li>
<li><p class="first">[Additional Information](#additional-information)
* [Perfomance Tests](#perfomance-tests)</p>
</li>
</ul>
</div></blockquote>
<p># Requirements</p>
<p>The following instructions assume the following requirements:</p>
<ul class="simple">
<li><strong>Operating System:</strong> Ubuntu 14.04 LTS or Debian 8 or CentOS 7</li>
</ul>
<p>Please report any errors you encounter at <a class="reference external" href="https://github.com/certtools/intelmq/issues">https://github.com/certtools/intelmq/issues</a></p>
<p># Install</p>
<p>## Install Dependencies</p>
<p>#### Python 3.4 (recommended)</p>
<p>##### Ubuntu 14.04 / Debian 8</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">python3</span> <span class="pre">python3-pip</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">git</span> <span class="pre">build-essential</span> <span class="pre">libcurl4-gnutls-dev</span> <span class="pre">libffi-dev</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">python-dev</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">redis-server</span>
<span class="pre">`</span></code></p>
<p>##### CentOS 7</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">epel-release</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">python34</span> <span class="pre">python34-devel</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">git</span> <span class="pre">libcurl-devel</span> <span class="pre">gcc</span> <span class="pre">gcc-c++</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">redis</span>
<span class="pre">`</span></code></p>
<p>Install the last pip version:
<code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">curl</span> <span class="pre">&quot;https://bootstrap.pypa.io/get-pip.py&quot;</span> <span class="pre">-o</span> <span class="pre">&quot;/tmp/get-pip.py&quot;</span>
<span class="pre">python3.4</span> <span class="pre">/tmp/get-pip.py</span>
<span class="pre">`</span></code></p>
<p>Enable redis on startup:
<code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">redis</span>
<span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">redis</span>
<span class="pre">`</span></code></p>
<p>#### Python 2.7</p>
<p>##### Ubuntu 14.04 / Debian 8</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">python</span> <span class="pre">python-pip</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">git</span> <span class="pre">build-essential</span> <span class="pre">libcurl4-gnutls-dev</span> <span class="pre">libffi-dev</span> <span class="pre">libgnutls28-dev</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">python-dev</span> <span class="pre">python-pycurl</span> <span class="pre">python-openssl</span> <span class="pre">python-pyasn1</span>
<span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">redis-server</span>
<span class="pre">`</span></code></p>
<p>##### CentOS 7</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">git</span> <span class="pre">libcurl-devel</span> <span class="pre">gcc</span> <span class="pre">gcc-c++</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">python</span> <span class="pre">python-devel</span>
<span class="pre">yum</span> <span class="pre">install</span> <span class="pre">redis</span>
<span class="pre">`</span></code></p>
<p>Enable redis (default broker) on startup:
<code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">redis</span>
<span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">redis</span>
<span class="pre">`</span></code></p>
<p>## Install</p>
<p>The <cite>REQUIREMENTS</cite> files define a list python packages and versions, which are necessary to run <em>all components</em> of IntelMQ. The defined versions are recommendations.</p>
<p>If you do not do any modifications on the code, use <cite>pip install intelmq</cite> instead of <cite>pip install .</cite>!</p>
<p>#### Python 3 (recommended)</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>bash
git clone <a class="reference external" href="https://github.com/certtools/intelmq.git">https://github.com/certtools/intelmq.git</a> /tmp/intelmq
cd /tmp/intelmq</p>
<p>sudo -s</p>
<p>pip3 install -r REQUIREMENTS
pip3 install .</p>
<p>useradd -d /opt/intelmq -U -s /bin/bash intelmq
echo &#8216;export PATH=&#8221;$PATH:$HOME/bin&#8221;&#8217; &gt;&gt; /opt/intelmq/.profile
chmod -R 0770 /opt/intelmq
chown -R intelmq.intelmq /opt/intelmq
echo &#8216;export INTELMQ_PYTHON=/usr/bin/python3&#8217; &gt;&gt; /opt/intelmq/.profile
<a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>#### Python 2.7</p>
<p><a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">`</span></a>bash
sudo -s</p>
<p>git clone <a class="reference external" href="https://github.com/certtools/intelmq.git">https://github.com/certtools/intelmq.git</a> /tmp/intelmq
cd /tmp/intelmq</p>
<p>pip2 install -r REQUIREMENTS2
pip2 install .</p>
<p>useradd -d /opt/intelmq -U -s /bin/bash intelmq
echo &#8216;export PATH=&#8221;$PATH:$HOME/bin&#8221;&#8217; &gt;&gt; /opt/intelmq/.profile
chmod -R 0770 /opt/intelmq
chown -R intelmq.intelmq /opt/intelmq
<a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a></p>
<p># Configuration</p>
<p>By default, one collector, one parser and one output are started. The default collector and the parser handle data from malware domain list, the file output bot writes all data to <cite>/opt/intelmq/var/lib/bots/file-output/events.txt</cite>.</p>
<p>The configuration directory is <cite>/opt/intelmq/etc/</cite>, all files are JSON.</p>
<ul class="simple">
<li><cite>defaults.conf</cite>: default values for bots and their behavior, e.g.</li>
</ul>
<p>error handling, log options and pipeline configuration. Will be removed in [future](<a class="reference external" href="https://github.com/certtools/intelmq/issues/267">https://github.com/certtools/intelmq/issues/267</a>).
* <cite>system.conf</cite>: System configuration for e.g. the logger and the pipeline.
* <cite>startup.conf</cite>: Maps the bot ids to python modules.
* <cite>runtime.conf</cite>: Configuration for the individual bots.
* <cite>pipeline.conf</cite>: Defines source and destination queues per bot.
* <cite>BOTS</cite>: Includes configuration hints for all bots. E.g. feed URLs or
database connection parameters. Use this as a template for <cite>startup.conf</cite> and <cite>runtime.conf</cite>. Also read by the intelmq-manager.</p>
<p>To configure a new bot, you need to define it first in <cite>startup.conf</cite>.
Then do the configuration in <cite>runtime.conf</cite> using the bot if.
Configure source and destination queues in <cite>pipeline.conf</cite>.
Use the IntelMQ Manager mentioned above to generate the configuration files if unsure.</p>
<p>## System Configuration</p>
<ul class="simple">
<li><cite>logging_handler</cite>: Can be one of <cite>&#8220;file&#8221;</cite> or <cite>&#8220;syslog&#8221;</cite>.</li>
<li><cite>logging_level</cite>: Defines for all system the level of logging that will be use by all bots and intelmqctl tool. Possible values are: <cite>&#8220;CRITICAL&#8221;</cite>, <cite>&#8220;ERROR&#8221;</cite>, <cite>&#8220;WARNING&#8221;</cite>, <cite>&#8220;INFO&#8221;</cite> and <cite>&#8220;DEBUG&#8221;</cite>.</li>
<li><cite>logging_path</cite>: If <cite>logging_handler</cite> is <cite>file</cite>. Defines for all system the logs folder that will be use by all bots and intelmqctl tool. Default value is: <cite>/opt/intelmq/var/log/</cite></li>
<li><cite>logging_syslog</cite>: If <cite>logging_handler</cite> is <cite>syslog</cite>. Either a list with hostname and UDP port of syslog service, e.g. <cite>[&#8220;localhost&#8221;, 514]</cite> or a device name, e.g. the default <cite>&#8220;/var/log&#8221;</cite>.</li>
</ul>
<p>## Startup Configuration</p>
<p>This configuration is used by intelmqctl tool to launch bots. Usually, the IntelMQ sysadmin don&#8217;t need to touch in this file because IntelMQ Manager generates it.</p>
<p><strong>Template:</strong>
<a href="#id17"><span class="problematic" id="id18">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;&lt;bot ID&gt;&#8221;: {</dt>
<dd>&#8220;group&#8221;: &#8220;&lt;bot type (Collector, Parser, Expert, Output)&gt;&#8221;,
&#8220;name&#8221;: &#8220;&lt;human-readable bot name&gt;&#8221;,
&#8220;module&#8221;: &#8220;&lt;bot code (python module)&gt;&#8221;,
&#8220;description&#8221;: &#8220;&lt;generic description of the bot&gt;&#8221;</dd>
</dl>
<p>},</p>
<blockquote>
<div>...</div></blockquote>
</div></blockquote>
<div class="section" id="id19">
<h1>}<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h1>
<p><strong>Example:</strong>
<a href="#id20"><span class="problematic" id="id21">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;malware-domain-list-collector&#8221;: {</dt>
<dd>&#8220;group&#8221;: &#8220;Collector&#8221;,
&#8220;name&#8221;: &#8220;Malware Domain List&#8221;,
&#8220;module&#8221;: &#8220;intelmq.bots.collectors.http.collector_http&#8221;,
&#8220;description&#8221;: &#8220;Malware Domain List Collector is the bot responsible to get the report from source of information.&#8221;</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id22">
<h1>}<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h1>
<p>More examples can be found at <cite>intelmq/conf/startup.conf</cite> directory in IntelMQ repository.</p>
<p>## Pipeline Configuration</p>
<p>This configuration is used by each bot to load the source pipeline and destination pipelines associated to each of them. IntelMQ Manager generate this configuration.</p>
<p><strong>Template:</strong>
<a href="#id23"><span class="problematic" id="id24">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;&lt;bot ID&gt;&#8221;: {</dt>
<dd><p class="first">&#8220;source-queue&#8221;: &#8220;&lt;source pipeline name&gt;&#8221;,
&#8220;destination-queues&#8221;: [</p>
<blockquote>
<div>&#8220;&lt;first destination pipeline name&gt;&#8221;,
&#8220;&lt;second destination pipeline name&gt;&#8221;,
...</div></blockquote>
<p class="last">]</p>
</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id25">
<h1>}<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h1>
<p><strong>Example:</strong>
<a href="#id26"><span class="problematic" id="id27">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;malware-domain-list-parser&#8221;: {</dt>
<dd><p class="first">&#8220;source-queue&#8221;: &#8220;malware-domain-list-parser-queue&#8221;,
&#8220;destination-queues&#8221;: [</p>
<blockquote>
<div>&#8220;file-output-queue&#8221;</div></blockquote>
<p class="last">]</p>
</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id28">
<h1>}<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h1>
<p>More examples can be found at <cite>intelmq/conf/pipeline.conf</cite> directory in IntelMQ repository.</p>
<p>## Defaults Configuration</p>
<p>All bots inherits this configuration parameters and they can overwrite them using the same parameters in configuration.</p>
<p>#### Error Handling</p>
<ul>
<li><dl class="first docutils">
<dt><strong>`error_log_message`</strong> - in case of an error, this option will allows the bot to write the message (report or event) in the log file. Use the following values:</dt>
<dd><ul class="first last simple">
<li><strong>`true/false`</strong> - write or not write message in log file</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>`error_log_exception`</strong> - in case of an error, this option will allows the bot to write the error exception in the log file. Use the following values:</dt>
<dd><ul class="first last simple">
<li><strong>`true/false`</strong> - write or not write exception in log file</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first"><strong>`error_procedure`</strong> - in case of an error, this option defines the procedure that the bot will adopt. Use the following values:</p>
<blockquote>
<div><ul class="simple">
<li><strong>`stop`</strong> - stop bot after retry X times, defined in <cite>error_max_retries</cite> option with a delay between retries defined at <cite>error_retry_delay</cite> option. If bot reach <cite>error_max_retries</cite> value, it will remove the message from pipeline and stop. If the option <cite>error_dump_message</cite> is enable, the bot will dump the removed message to the dump log.</li>
<li><strong>`pass`</strong> - will pass to the next message after retry X times, removing from pipeline the current message. If the option <cite>error_dump_message</cite> is enable, the bot will dump the removed message to the dump log.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><strong>`error_max_retries`</strong> - in case of an error and the value of the <cite>error_procedure</cite> option is <cite>retry</cite>, bot will try to start processing the current message X times defined at <cite>error_max_retries</cite> option. The value must be an <cite>integer value</cite>.</p>
</li>
<li><p class="first"><strong>`error_retry_delay`</strong> - in case of an error, this option will allows you to define the number of seconds which bot will wait until next retry. The value must be an <cite>integer value</cite>.</p>
</li>
<li><dl class="first docutils">
<dt><strong>`error_dump_message`</strong> - in case of an error, this option will allows the bot to write the message (report or event) in the dump file (use intelmqdump to re-insert the message).</dt>
<dd><ul class="first last simple">
<li><strong>`true/false`</strong> - write or not write message in dump file</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>#### Miscellaneous</p>
<ul>
<li><dl class="first docutils">
<dt><strong>`load_balance`</strong> - this option allows you to choose the behavior of the queue. Use the following values:</dt>
<dd><ul class="first last simple">
<li><strong>`true`</strong> - splits the messages into several queues wihtout duplication</li>
<li><strong>`false`</strong> - duplicates the messages into each queue</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>`broker`</strong> - select which broker intelmq can use. Use the following values:</dt>
<dd><ul class="first last simple">
<li><strong>`redis`</strong> - Redis allows some persistence but is not so fast as ZeroMQ (in development).</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first"><strong>`rate_limit`</strong> - time interval (in seconds) between messages processing. The value must be an <cite>integer value</cite>.</p>
</li>
<li><p class="first"><strong>`source_pipeline_host`</strong> - broker IP or FQDN that the bot will use to connect and receive messages.</p>
</li>
<li><p class="first"><strong>`source_pipeline_port`</strong> - broker port that the bot will use to connect and receive messages.</p>
</li>
<li><p class="first"><strong>`source_pipeline_db`</strong> - broker database that the bot will use to connect and receive messages (requirement from redis broker).</p>
</li>
<li><p class="first"><strong>`destination_pipeline_host`</strong> - broker IP or FQDN that the bot will use to connect and send messages.</p>
</li>
<li><p class="first"><strong>`destination_pipeline_port`</strong> - broker port that the bot will use to connect and send messages.</p>
</li>
<li><p class="first"><strong>`destination_pipeline_db`</strong> - broker database that the bot will use to connect and send messages (requirement from redis broker).</p>
</li>
<li><p class="first"><strong>`http_proxy`</strong> - proxy HTTP the that bot will use when performing HTTP requests (e.g. bots/collectors/collector_http.py). The value must follow RFC1738.</p>
</li>
<li><p class="first"><strong>`https_proxy`</strong> - proxy HTTPS that the bot will use when performing secure HTTPS requests (e.g. bots/collectors/collector_http.py).</p>
</li>
<li><p class="first"><strong>`http_user_agent`</strong> - user-agent that the bot will use when performing HTTP/HTTPS requests (e.g. bots/collectors/collector_http.py).</p>
</li>
<li><dl class="first docutils">
<dt><strong>`http_verify_cert`</strong> - defines if the bot will verify SSL certificates when performing HTTPS requests (e.g. bots/collectors/collector_http.py).</dt>
<dd><ul class="first last simple">
<li><strong>`true/false`</strong> - verify or not verify SSL certificates</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>## Runtime Configuration</p>
<p>This configuration is used by each bot to load the specific parameters associated to each of them. Usually, BOTS file is used to generate runtime.conf. IntelMQ Manager generate this configuration.</p>
<p><strong>Template:</strong>
<a href="#id29"><span class="problematic" id="id30">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;&lt;bot ID&gt;&#8221;: {</dt>
<dd>&#8220;&lt;parameter 1&gt;&#8221;: &#8220;&lt;value 1&gt;&#8221;,
&#8220;&lt;parameter 2&gt;&#8221;: &#8220;&lt;value 2&gt;&#8221;,
&#8220;&lt;parameter 3&gt;&#8221;: &#8220;&lt;value 3&gt;&#8221;</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id31">
<h1>}<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h1>
<p><strong>Example:</strong>
<a href="#id32"><span class="problematic" id="id33">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;malware-domain-list-collector&#8221;: {</dt>
<dd>&#8220;http_url&#8221;: &#8220;<a class="reference external" href="http://www.malwaredomainlist.com/updatescsv.php">http://www.malwaredomainlist.com/updatescsv.php</a>&#8221;,
&#8220;feed&#8221;: &#8220;Malware Domain List&#8221;,
&#8220;rate_limit&#8221;: 3600</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id34">
<h1>}<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h1>
<p>More examples can be found at <cite>intelmq/conf/runtime.conf</cite> directory in IntelMQ repository.</p>
<p>## Harmonization Configuration</p>
<p>This configuration is used to specify the fields for all message types. The harmonization library will load this configuration to check, during the message processing, the values are compliant to harmonization. Usually, this configuration doesn&#8217;t need any change.</p>
<p><strong>Template:</strong>
<a href="#id35"><span class="problematic" id="id36">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;&lt;message type&gt;&#8221;: {</dt>
<dd><dl class="first docutils">
<dt>&#8220;&lt;field 1&gt;&#8221;: {</dt>
<dd>&#8220;description&#8221;: &#8220;&lt;field 1 description&gt;&#8221;,
&#8220;type&#8221;: &#8220;&lt;field value type&gt;&#8221;</dd>
</dl>
<p>},
&#8220;&lt;field 2&gt;&#8221;: {</p>
<blockquote>
<div>&#8220;description&#8221;: &#8220;&lt;field 2 description&gt;&#8221;,
&#8220;type&#8221;: &#8220;&lt;field value type&gt;&#8221;</div></blockquote>
<p class="last">}</p>
</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id37">
<h1>}<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h1>
<p><strong>Example:</strong>
<a href="#id38"><span class="problematic" id="id39">``</span></a>`
{</p>
<blockquote>
<div><blockquote>
<div>...</div></blockquote>
<dl class="docutils">
<dt>&#8220;event&#8221;: {</dt>
<dd><dl class="first docutils">
<dt>&#8220;destination.asn&#8221;: {</dt>
<dd>&#8220;description&#8221;: &#8220;The autonomous system number from which originated the connection.&#8221;,
&#8220;type&#8221;: &#8220;Integer&#8221;</dd>
</dl>
<p>},
&#8220;destination.geolocation.cc&#8221;: {</p>
<blockquote class="last">
<div>&#8220;description&#8221;: &#8220;Country-Code accoriding to ISO3166-1 alpha-2 for the destination IP.&#8221;,
&#8220;regex&#8221;: &#8220;^[a-zA-Z0-9]{2}$&#8221;,
&#8220;type&#8221;: &#8220;String&#8221;</div></blockquote>
</dd>
<dt>},</dt>
<dd>...</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id40">
<h1>}<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h1>
<p>More examples can be found at <cite>intelmq/conf/harmonization.conf</cite> directory in IntelMQ repository.</p>
<p># Utilities</p>
<p>## Management</p>
<p>IntelMQ has a modular structure consisting on bots. There are four types of bots:</p>
<ul class="simple">
<li><em>CollectorBots</em> retrieve data from internal or external sources, the output</li>
</ul>
<p>are <em>reports</em> consisting of many individual data sets.
* <em>ParserBots</em> parse the data by splitting it into individual <em>events</em> and
giving them a defined structure, see also [Data Harmonization](Data-Harmonization.md).
* <em>ExpertBots</em> enrich the existing events by e.g. reverse records, geographic location information or abuse contacts.
* <em>OutputBots</em> write events to files, databases, (REST)-APIs, etc.</p>
<p>Each bot has one source queue (except collectors) and can have multiple
destination queues (except outputs). But multiple bots can write to the same pipeline, resulting in multiple inputs for the next bot.</p>
<p>Every bot runs in a separate process, they are uniquely identifiable by a <em>bot id</em>.</p>
<p>Currently only one instance of one bot can be run. Concepts for multiprocessing are being discussed, see this issue: [Multiprocessing per queue is not supported #186](<a class="reference external" href="https://github.com/certtools/intelmq/issues/186">https://github.com/certtools/intelmq/issues/186</a>).</p>
<p>### Web interface: IntelMQ Manager</p>
<p>IntelMQ has a tool called IntelMQ Manager that gives to user a easy way to
configure all pipeline with bots that your team needs. It is recommended to
use the IntelMQ Manager to become acquainted with the functionalities and concepts.
The IntelMQ Manager has all possibilities of intelmqctl tool and has a graphical interface for startup and pipeline configuration.</p>
<p>See [IntelMQ Manager repository](<a class="reference external" href="https://github.com/certtools/intelmq-manager">https://github.com/certtools/intelmq-manager</a>).</p>
<p>### Command-line interface: intelmqctl</p>
<p><strong>Syntax:</strong></p>
<p><a href="#id41"><span class="problematic" id="id42">``</span></a><a href="#id43"><span class="problematic" id="id44">`</span></a>bash
# su - intelmq</p>
<p>$ intelmqctl &#8211;h
usage:</p>
<blockquote>
<div>intelmqctl &#8211;bot [start|stop|restart|status] &#8211;id=cymru-expert
intelmqctl &#8211;botnet [start|stop|restart|status]
intelmqctl &#8211;list [bots|queues]</div></blockquote>
<dl class="docutils">
<dt>optional arguments:</dt>
<dd><table class="first docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></td>
<td>show this help message and exit</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-v</span>, <span class="option">--version</span></kbd></td>
<td>show program&#8217;s version number and exit</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--id <var>BOT_ID</var></span>, <span class="option">-i <var>BOT_ID</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>bot ID</td></tr>
</tbody>
</table>
<dl class="docutils">
<dt>&#8211;type {text,json}, -t {text,json}</dt>
<dd>choose if it should return regular text or other forms
of output</dd>
<dt>&#8211;log [log-level]:[number-of-lines], -l [log-level]:[number-of-lines]</dt>
<dd>Reads the last lines from bot log, or from system log
if no bot ID was given. Log level should be one of
DEBUG, INFO, ERROR or CRTICAL. Default is INFO. Number
of lines defaults to 10, -1 gives all. Reading from
system log is not implemented yet.</dd>
</dl>
<p>&#8211;bot [start|stop|restart|status], -b [start|stop|restart|status]
&#8211;botnet [start|stop|restart|status], -n [start|stop|restart|status]
&#8211;list [bots|queues], -s [bots|queues]
&#8211;clear queue, -c queue</p>
<blockquote class="last">
<div>Clears the given queue in broker</div></blockquote>
</dd>
</dl>
<p>description: intelmqctl is the tool to control intelmq system. Outputs are
logged to /opt/intelmq/var/log/intelmqctl
<a href="#id45"><span class="problematic" id="id46">``</span></a><a href="#id47"><span class="problematic" id="id48">`</span></a></p>
<p>#### Botnet Concept</p>
<p>The botnet represents all currently configured bots. To get an overview which bots are running, use <a href="#id49"><span class="problematic" id="id50">`</span></a>intelmqctl -n status`or use IntelMQ Manager.</p>
<p>#### Start bots with non-default Python</p>
<p>The python version/path can be specified by the <cite>INTELMQ_PYTHON</cite> environment variable. By default it&#8217;s the default python binary. This can be used to start the bots with current Python (version 3), while the default Python version for the operating system is still Legacy Python (version 2).</p>
<p><code class="docutils literal"><span class="pre">`</span>
<span class="pre">$</span> <span class="pre">export</span> <span class="pre">INTELMQ_PYTHON=/usr/bin/python3.4</span>
<span class="pre">$</span> <span class="pre">intelmqctl</span> <span class="pre">-n</span> <span class="pre">start</span>
<span class="pre">`</span></code></p>
<p>#### Forcing reset pipeline and cache (be careful)</p>
<p>If you are using the default broker (Redis), in some test situations you may need to quickly clear all pipelines and caches. Use the following procedure:
<code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">redis-cli</span> <span class="pre">FLUSHDB</span>
<span class="pre">redis-cli</span> <span class="pre">FLUSHALL</span>
<span class="pre">`</span></code></p>
<p>## Error Handling</p>
<p>### Tool: intelmqdump</p>
<p>When bots are failing due to bad input data or programming errors, they can dump the problematic message to a file along with a traceback, if configured accordingly. These dumps are saved at <cite>/opt/intelmq/var/log/[botid].dump</cite> as JSON files. There is an inspection and reinjection tool included in intelmq, called <cite>intelmqdump</cite>. It is an interactive tool able to show all dumped files, the number of dumps per file. Choose a file by bot-id or listed numeric id. You can then choose to delete single entries from the file with <cite>e 1,3,4</cite>, show a message in more readable format with <cite>s 1</cite> (prints the raw-message, can be long!), recover some messages and put them back in the pipeline for the bot by <cite>a</cite> or <cite>r 0,4,5</cite>. Or delete the file with all dumped messages using <cite>d</cite>.</p>
<dl class="docutils">
<dt><a href="#id51"><span class="problematic" id="id52">``</span></a><a href="#id53"><span class="problematic" id="id54">`</span></a>bash</dt>
<dd>$ intelmqdump -h</dd>
<dt>usage:</dt>
<dd>intelmqdump [botid]
intelmqdump [-h|&#8211;help]</dd>
</dl>
<p>intelmqdump can inspect dumped messages, show, delete or reinject them into
the pipeline. It&#8217;s an interactive tool, directly start it to get a list of
available dumps or call it with a known bot id as parameter.</p>
<dl class="docutils">
<dt>positional arguments:</dt>
<dd>botid       botid to inspect dumps of</dd>
<dt>optional arguments:</dt>
<dd><table class="first last docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-h</span>, <span class="option">--help</span></kbd></td>
<td>show this help message and exit</td></tr>
</tbody>
</table>
</dd>
</dl>
<p>Interactive actions after a file has been selected:
- r, Recover by IDs</p>
<blockquote>
<div>&gt; r id{,id} [queue name]
&gt; r 3,4,6
&gt; r 3,7,90 modify-expert-queue
The messages identified by a consecutive numbering will be stored in the
original queue or the given one and removed from the file.</div></blockquote>
<ul class="simple">
<li>a, Recover all
&gt; a [queue name]
&gt; a
&gt; a modify-expert-queue
All messages in the opened file will be recovered to the stored or given
queue and removed from the file.</li>
<li>e, Delete entries by IDs
&gt; e id{,id}
&gt; e 3,5
The entries will be deleted from the dump file.</li>
<li>d, Delete file
&gt; d
Delete the opened file as a whole.</li>
<li>s, Show by IDs
&gt; s id{,id}
&gt; s 0,4,5
Show the selected IP in a readable format. It&#8217;s still a raw format from
repr, but with newlines for message and traceback.</li>
<li>q, Quit
&gt; q</li>
</ul>
<dl class="docutils">
<dt>$ intelmqdump</dt>
<dd><dl class="first last docutils">
<dt>id: name (bot id)                    content</dt>
<dd>0: alienvault-otx-parser            1 dumps
1: cymru-whois-expert               8 dumps
2: deduplicator-expert              2 dumps
3: dragon-research-group-ssh-parser 2 dumps
4: file-output2                     1 dumps
5: fraunhofer-dga-parser            1 dumps
6: spamhaus-cert-parser             4 dumps
7: test-bot                         2 dumps</dd>
</dl>
</dd>
</dl>
<p>Which dump file to process (id or name)? 3
Processing dragon-research-group-ssh-parser: 2 dumps</p>
<blockquote>
<div>0: 2015-09-03T13:13:22.159014 InvalidValue: invalid value u&#8217;NA&#8217; (&lt;type &#8216;unicode&#8217;&gt;) for key u&#8217;source.asn&#8217;
1: 2015-09-01T14:40:20.973743 InvalidValue: invalid value u&#8217;NA&#8217; (&lt;type &#8216;unicode&#8217;&gt;) for key u&#8217;source.asn&#8217;</div></blockquote>
<p>recover (a)ll, delete (e)ntries, (d)elete file, (q)uit, (s)how by ids, (r)ecover by ids? d
Deleted file /opt/intelmq/var/log/dragon-research-group-ssh-parser.dump
<a href="#id55"><span class="problematic" id="id56">``</span></a><a href="#id57"><span class="problematic" id="id58">`</span></a></p>
<p>## Monitoring Logs</p>
<p>All bots and <cite>intelmqctl</cite> log to <cite>/opt/intelmq/var/log/</cite>. In case of failures, messages are dumped to the same directory with file ending <cite>.dump</cite>.</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">tail</span> <span class="pre">-f</span> <span class="pre">/opt/intelmq/var/log/*.log</span>
<span class="pre">`</span></code></p>
<p># Upgrade</p>
<p>## Stop IntelMQ and Backup</p>
<ul class="simple">
<li>Make sure that your IntelMQ system is completely stopped.</li>
<li>Create a backup of IntelMQ Home directory, which includes all configurations. They are not overwritten, but backups are always nice to have!</li>
</ul>
<p><a href="#id59"><span class="problematic" id="id60">``</span></a><a href="#id61"><span class="problematic" id="id62">`</span></a>bash
sudo su -</p>
<p>cp -R /opt/intelmq /opt/intelmq-backup
<a href="#id63"><span class="problematic" id="id64">``</span></a><a href="#id65"><span class="problematic" id="id66">`</span></a></p>
<p>## Upgrade</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">cd</span> <span class="pre">intelmq/</span>
<span class="pre">git</span> <span class="pre">pull</span>
<span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-U</span> <span class="pre">intelmq</span>&nbsp; <span class="pre">#</span> <span class="pre">or</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-U</span> <span class="pre">.</span> <span class="pre">if</span> <span class="pre">you</span> <span class="pre">have</span> <span class="pre">a</span> <span class="pre">local</span> <span class="pre">repository</span>
<span class="pre">`</span></code></p>
<p>## Restore Configurations</p>
<ul class="simple">
<li>Apply your configurations backup.</li>
</ul>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/opt/intelmq/etc/*</span>
<span class="pre">cp</span> <span class="pre">-R</span> <span class="pre">/opt/intelmq-backup/etc/*</span> <span class="pre">/opt/intelmq/etc/</span>
<span class="pre">`</span></code></p>
<p>## Redefine permissions</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">chmod</span> <span class="pre">-R</span> <span class="pre">0770</span> <span class="pre">/opt/intelmq</span>
<span class="pre">chown</span> <span class="pre">-R</span> <span class="pre">intelmq.intelmq</span> <span class="pre">/opt/intelmq</span>
<span class="pre">`</span></code></p>
<p># Uninstall</p>
<p><code class="docutils literal"><span class="pre">`bash</span>
<span class="pre">pip</span> <span class="pre">uninstall</span> <span class="pre">intelmq</span>
<span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/opt/intelmq</span>
<span class="pre">`</span></code></p>
<p># Frequently Asked Questions</p>
<p>Consult the [FAQ.md](FAQ) if you encountered any problem.</p>
<p># Additional Information</p>
<p>## Perfomance Tests</p>
<p>Somes tests have been made with a virtual machine with
the following specifications:</p>
<ul class="simple">
<li>CPU: 1 core dedicated from i7 processor</li>
<li>Memory: 4GB</li>
<li>HDD: 10GB</li>
</ul>
<p>The entire solution didnt have any problem handling 2.000.000
queued events in memory with bots digesting the messages.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">}</a></li>
<li><a class="reference internal" href="#id22">}</a></li>
<li><a class="reference internal" href="#id25">}</a></li>
<li><a class="reference internal" href="#id28">}</a></li>
<li><a class="reference internal" href="#id31">}</a></li>
<li><a class="reference internal" href="#id34">}</a></li>
<li><a class="reference internal" href="#id37">}</a></li>
<li><a class="reference internal" href="#id40">}</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="contents.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/User-Guide.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
      |
      <a href="_sources/User-Guide.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>