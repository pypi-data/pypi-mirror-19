"""

Author: Thomas Cokelaer
Affiliation: Institut Pasteur
Summary: a rule to create the DAG image from the Snakemake
Data:
Run: snakemake -s Snakefile
Changelog:

"""


rule dag:
    """DAG

    :param filename: input dot file to be parsed

    """
    input: 
        filename = __dag__input
    output:
        dot  = temp("dag.dot"),
        dot2 = temp("dag.ann.dot"),
        svg  = __dag__output
    message: """
    -- Creating DAG in a dot file and save into report/dag.svg
    """
    run:
        # Create the dot file (graphviz) using snakemake
        shell("snakemake -s {input.filename} --dag --nolock > {output.dot}")

        # Annotate the dag with URLs 
        from sequana.snaketools import DOTParser
        d = DOTParser(output.dot)
        d.add_urls()

        # Now, create the SVG. Somehow if called dag.svg, this is a conflict
        # hence the || true 
        shell("dot -Tsvg {output.dot2} -o {output.svg} || true")

