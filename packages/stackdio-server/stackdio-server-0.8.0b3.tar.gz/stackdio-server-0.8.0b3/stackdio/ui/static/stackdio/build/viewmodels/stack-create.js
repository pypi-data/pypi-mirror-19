/*!
  * Copyright 2016,  Digital Reasoning
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *
*/

define(["jquery","knockout","ladda","bootbox","utils/formula-versions","models/formula-version","fuelux","select2"],function(e,r,t,s,o,a){"use strict";return function(){var n=this;n.breadcrumbs=[{active:!1,title:"Stacks",href:"/stacks/"},{active:!0,title:"New"}],n.blueprintSelector=e("#stackBlueprint"),window.stackdio.blueprintId&&n.blueprintSelector.append('<option value="'+window.stackdio.blueprintId+'" title="'+window.stackdio.blueprintText+'">'+window.stackdio.blueprintText+"</option>"),n.blueprintSelector.select2({ajax:{url:"/api/blueprints/",dataType:"json",delay:100,data:function(e){return{q:e.term}},processResults:function(e){return e.results.forEach(function(e){e.text=e.title}),e},cache:!0},theme:"bootstrap",placeholder:"Select a blueprint...",templateResult:function(e){return e.loading?e.text:e.title+"  --  "+e.description},minimumInputLength:0}),n.selectBlueprint=function(r){function t(r){e.ajax({method:"GET",url:r}).done(function(e){i.push.apply(i,e.results.map(function(e){return new a(e,n)})),null===e.next?(n.formulaVersions(i),n.formulas?n.createSelectors():o.getAllFormulas(function(e){n.formulas=e,n.createSelectors()})):t(e.next)})}n.createUsers(r.create_users),n.blueprintId(r.id);var s=["blueprint","title","description","create_users","namespace","properties"];n.removeErrors(s),e.ajax({method:"GET",url:r.properties}).done(function(e){n.properties(e)});var i=[];t(r.formula_versions)},n.blueprintSelector.on("select2:select",function(e){var r=e.params.data;n.selectBlueprint(r)}),n.blueprintId=r.observable(),n.title=r.observable(),n.description=r.observable(),n.createUsers=r.observable(),n.namespace=r.observable(),n.properties=r.observable({}),n.formulaVersions=r.observableArray([]),n.formulas=null,n.versionsReady=r.observable(),n.validProperties=!0,n.createButton=null,n.propertiesJSON=r.pureComputed({read:function(){return r.toJSON(n.properties(),null,3)},write:function(e){try{n.properties(JSON.parse(e)),n.validProperties=!0}catch(e){n.validProperties=!1}}}),n.subscription=null,n.reset=function(){n.subscription&&n.subscription.dispose();var r=e(".checkbox-custom");n.subscription=n.createUsers.subscribe(function(e){e?r.checkbox("check"):r.checkbox("uncheck")}),n.blueprintId(null),n.title(""),n.description(""),n.createUsers(!1),n.namespace(""),n.properties({}),n.formulaVersions([]),n.versionsReady(!1),window.stackdio.blueprintId&&(n.blueprintSelector.val(window.stackdio.blueprintId).trigger("change"),e.ajax({method:"GET",url:"/api/blueprints/"+window.stackdio.blueprintId+"/"}).done(function(e){n.selectBlueprint(e)}))},n.createSelectors=function(){var e=[];n.formulaVersions().forEach(function(r){o.createVersionSelector(r,n.formulas)||e.push(r)}),e.forEach(function(e){n.formulaVersions.remove(e)}),n.versionsReady(!0)},n.removeErrors=function(r){r.forEach(function(r){var t=e("#"+r);t.removeClass("has-error");var s=t.find(".help-block");s.remove()})},n.getVersionsData=function(){return n.formulaVersions().map(function(e){return{formula:e.formula(),version:e.version()}})},n.createStack=function(){var r=["blueprint","title","description","create_users","namespace","properties"];if(n.removeErrors(r),!n.validProperties){var o=e("#properties");return o.addClass("has-error"),void o.append('<span class="help-block">Invalid JSON.</span>')}var a=t.create(document.querySelector("#create-button"));a.start(),e.ajax({method:"POST",url:"/api/stacks/",data:JSON.stringify({blueprint:n.blueprintId(),title:n.title(),description:n.description(),create_users:n.createUsers(),namespace:n.namespace(),properties:n.properties(),formula_versions:n.getVersionsData()})}).always(function(){a.stop()}).done(function(){window.location="/stacks/"}).fail(function(t){var o="";try{var a=JSON.parse(t.responseText);for(var n in a)if(a.hasOwnProperty(n))if(r.indexOf(n)>=0){var i=e("#"+n);i.addClass("has-error"),a[n].forEach(function(e){i.append('<span class="help-block">'+e+"</span>")})}else if("non_field_errors"===n)a[n].forEach(function(r){if(r.indexOf("title")>=0){var t=e("#title");t.addClass("has-error"),t.append('<span class="help-block">A stack with this title already exists.</span>')}});else{var l=n.replace("_"," ");a[n].forEach(function(e){o+="<dt>"+l+"</dt><dd>"+e+"</dd>"})}o&&(o='<dl class="dl-horizontal">'+o+"</dl>")}catch(e){o="Oops... there was a server error.  This has been reported to your administrators."}o&&s.alert({title:"Error creating stack",message:o})})},n.reset()}});