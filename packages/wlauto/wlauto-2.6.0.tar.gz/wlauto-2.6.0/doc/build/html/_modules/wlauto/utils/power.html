<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>wlauto.utils.power &#8212; Workload Automation 2.6.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Workload Automation 2.6.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for wlauto.utils.power</h1><div class="highlight"><pre>
<span></span><span class="c1">#    Copyright 2015 ARM Limited</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">c_int32</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">wlauto.utils.trace_cmd</span> <span class="k">import</span> <span class="n">TraceCmdTrace</span><span class="p">,</span> <span class="n">TRACE_MARKER_START</span><span class="p">,</span> <span class="n">TRACE_MARKER_STOP</span>
<span class="kn">from</span> <span class="nn">wlauto.exceptions</span> <span class="k">import</span> <span class="n">DeviceError</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;power&#39;</span><span class="p">)</span>

<span class="n">UNKNOWN_FREQUENCY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">INIT_CPU_FREQ_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;CPU (?P&lt;cpu&gt;\d+) FREQUENCY: (?P&lt;freq&gt;\d+) kHZ&#39;</span><span class="p">)</span>
<span class="n">DEVLIB_CPU_FREQ_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;cpu_frequency(?:_devlib):\s+state=(?P&lt;freq&gt;\d+)\s+cpu_id=(?P&lt;cpu&gt;\d+)&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="CorePowerTransitionEvent"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.CorePowerTransitionEvent">[docs]</a><span class="k">class</span> <span class="nc">CorePowerTransitionEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;transition&#39;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu_id&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;idle_state&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">cpu_id</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idle_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">idle_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Power transition must specify a frequency or an idle_state, but not both.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_id</span> <span class="o">=</span> <span class="n">cpu_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="n">idle_state</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;cpu </span><span class="si">{}</span><span class="s1"> @ </span><span class="si">{}</span><span class="s1"> -&gt; freq: </span><span class="si">{}</span><span class="s1"> idle: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;CPTE(c:</span><span class="si">{}</span><span class="s1"> t:</span><span class="si">{}</span><span class="s1"> f:</span><span class="si">{}</span><span class="s1"> i:</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span><span class="p">)</span></div>


<div class="viewcode-block" id="CorePowerDroppedEvents"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.CorePowerDroppedEvents">[docs]</a><span class="k">class</span> <span class="nc">CorePowerDroppedEvents</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;dropped_events&#39;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cpu_id&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpu_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_id</span> <span class="o">=</span> <span class="n">cpu_id</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;DROPPED EVENTS on CPU</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span></div>


<div class="viewcode-block" id="TraceMarkerEvent"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.TraceMarkerEvent">[docs]</a><span class="k">class</span> <span class="nc">TraceMarkerEvent</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;marker&#39;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;MARKER: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="CpuPowerState"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.CpuPowerState">[docs]</a><span class="k">class</span> <span class="nc">CpuPowerState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;idle_state&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_idling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idle_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="n">idle_state</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;CP(f:</span><span class="si">{}</span><span class="s1"> i:</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span></div>


<div class="viewcode-block" id="SystemPowerState"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.SystemPowerState">[docs]</a><span class="k">class</span> <span class="nc">SystemPowerState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;cpus&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_cores</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">num_cores</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CpuPowerState</span><span class="p">())</span>

<div class="viewcode-block" id="SystemPowerState.copy"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.SystemPowerState.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">SystemPowerState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cores</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">):</span>
            <span class="n">new</span><span class="o">.</span><span class="n">cpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frequency</span>
            <span class="n">new</span><span class="o">.</span><span class="n">cpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">idle_state</span>
        <span class="k">return</span> <span class="n">new</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;SP(t:</span><span class="si">{}</span><span class="s1"> Cs:</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span></div>


<div class="viewcode-block" id="PowerStateProcessor"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateProcessor">[docs]</a><span class="k">class</span> <span class="nc">PowerStateProcessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This takes a stream of power transition events and yields a timeline stream</span>
<span class="sd">    of system power states.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cpu_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_state</span><span class="o">.</span><span class="n">cpus</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_state</span><span class="o">.</span><span class="n">timestamp</span>

    <span class="nd">@current_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_state</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_clusters</span><span class="p">,</span> <span class="n">num_idle_states</span><span class="p">,</span>
                 <span class="n">first_cluster_state</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">,</span> <span class="n">first_system_state</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">,</span>
                 <span class="n">wait_for_start_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">SystemPowerState</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requested_states</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># cpu_id -&gt; requeseted state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_start_marker</span> <span class="o">=</span> <span class="n">wait_for_start_marker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saw_start_marker</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saw_stop_marker</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">idle_state_domains</span> <span class="o">=</span> <span class="n">build_idle_domains</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">,</span>
                                                <span class="n">num_states</span><span class="o">=</span><span class="n">num_idle_states</span><span class="p">,</span>
                                                <span class="n">first_cluster_state</span><span class="o">=</span><span class="n">first_cluster_state</span><span class="p">,</span>
                                                <span class="n">first_system_state</span><span class="o">=</span><span class="n">first_system_state</span><span class="p">)</span>
        <span class="c1"># This tells us what other cpus we need to update when we see an idle</span>
        <span class="c1"># state transition event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_related_cpus</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># (cpu, idle_state) --&gt; relate_cpus_list</span>
        <span class="k">for</span> <span class="n">state_id</span><span class="p">,</span> <span class="n">idle_state_domain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idle_state_domains</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cpu_group</span> <span class="ow">in</span> <span class="n">idle_state_domain</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cpu</span> <span class="ow">in</span> <span class="n">cpu_group</span><span class="p">:</span>
                    <span class="n">related</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cpu_group</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">cpu</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idle_related_cpus</span><span class="p">[(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">state_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">related</span>

<div class="viewcode-block" id="PowerStateProcessor.process"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateProcessor.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_stream</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">event_stream</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_power_state</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saw_start_marker</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_start_marker</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">next_state</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saw_stop_marker</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_start_marker</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Did not see a STOP marker in the trace&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PowerStateProcessor.update_power_state"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateProcessor.update_power_state">[docs]</a>    <span class="k">def</span> <span class="nf">update_power_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the tracked power state based on the specified event and</span>
<span class="sd">        return updated power state.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;transition&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_transition</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;dropped_events&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_dropped_events</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;marker&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;START&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saw_start_marker</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;STOP&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_saw_stop_marker</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected event type: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">kind</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_process_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">idle_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_idle_exit</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_idle_entry</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_dropped_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">old_idle_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">related_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_related_cpus</span><span class="p">[(</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">old_idle_state</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">related_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_process_idle_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_idling</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Got idle state entry event for an idling core: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_try_transition_to_idle_state</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">idle_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_idle_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Got idle state exit event for an active core: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requested_states</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># remove outstanding request if there is one</span>
        <span class="n">old_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">UNKNOWN_FREQUENCY</span>

        <span class="n">related_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_related_cpus</span><span class="p">[(</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">old_state</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">old_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="n">old_state</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">related_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">&gt;</span> <span class="n">new_state</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_try_transition_to_idle_state</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_transition_to_idle_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpu_id</span><span class="p">,</span> <span class="n">idle_state</span><span class="p">):</span>
        <span class="n">related_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_related_cpus</span><span class="p">[(</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">idle_state</span><span class="p">)]</span>
        <span class="n">idle_state</span> <span class="o">=</span> <span class="n">idle_state</span>

        <span class="c1"># Tristate: True - can transition, False - can&#39;t transition,</span>
        <span class="c1">#           None - unknown idle state on at least one related cpu</span>
        <span class="n">transition_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_enter_state</span><span class="p">(</span><span class="n">related_ids</span><span class="p">,</span> <span class="n">idle_state</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">transition_check</span><span class="p">:</span>
            <span class="c1"># If we can&#39;t enter an idle state right now, record that we&#39;ve</span>
            <span class="c1"># requested it, so that we may enter it later (once all related</span>
            <span class="c1"># cpus also want a state at least as deep).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requested_states</span><span class="p">[</span><span class="n">cpu_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">idle_state</span>

        <span class="k">if</span> <span class="n">transition_check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unknown state on a related cpu means we&#39;re not sure whether we&#39;re</span>
            <span class="c1"># entering requested state or a shallower one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="c1"># Keep trying shallower states until all related</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_enter_state</span><span class="p">(</span><span class="n">related_ids</span><span class="p">,</span> <span class="n">idle_state</span><span class="p">):</span>
            <span class="n">idle_state</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">related_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_related_cpus</span><span class="p">[(</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">idle_state</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">cpu_id</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="n">idle_state</span>
        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">related_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">=</span> <span class="n">idle_state</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="o">==</span> <span class="n">idle_state</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span>  <span class="c1"># request satisfied, so remove</span>

    <span class="k">def</span> <span class="nf">_can_enter_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">related_ids</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a tri-state check. Returns ``True`` if related cpu states allow transition</span>
<span class="sd">        into this state, ``False`` if related cpu states don&#39;t allow transition into this</span>
<span class="sd">        state, and ``None`` if at least one of the related cpus is in an unknown state</span>
<span class="sd">        (so the decision of whether a transition is possible cannot be made).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">related_ids</span><span class="p">:</span>
            <span class="n">rid_requested_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span>
            <span class="n">rid_current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">idle_state</span>
            <span class="k">if</span> <span class="n">rid_current_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">rid_current_state</span> <span class="o">&lt;</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">rid_requested_state</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="stream_cpu_power_transitions"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.stream_cpu_power_transitions">[docs]</a><span class="k">def</span> <span class="nf">stream_cpu_power_transitions</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;cpu_idle&#39;</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">c_int32</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="k">yield</span> <span class="n">CorePowerTransitionEvent</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">idle_state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;cpu_frequency&#39;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">CorePowerTransitionEvent</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;DROPPED EVENTS DETECTED&#39;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">CorePowerDroppedEvents</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">cpu_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">TRACE_MARKER_START</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">TraceMarkerEvent</span><span class="p">(</span><span class="s1">&#39;START&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">TRACE_MARKER_STOP</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">TraceMarkerEvent</span><span class="p">(</span><span class="s1">&#39;STOP&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;cpu_frequency&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">DEVLIB_CPU_FREQ_REGEX</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">INIT_CPU_FREQ_REGEX</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">CorePowerTransitionEvent</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                                                   <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)),</span>
                                                   <span class="n">frequency</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;freq&#39;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="gather_core_states"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.gather_core_states">[docs]</a><span class="k">def</span> <span class="nf">gather_core_states</span><span class="p">(</span><span class="n">system_state_stream</span><span class="p">,</span> <span class="n">freq_dependent_idle_states</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># NOQA</span>
    <span class="k">if</span> <span class="n">freq_dependent_idle_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">freq_dependent_idle_states</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">system_state</span> <span class="ow">in</span> <span class="n">system_state_stream</span><span class="p">:</span>
        <span class="n">core_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cpu</span> <span class="ow">in</span> <span class="n">system_state</span><span class="o">.</span><span class="n">cpus</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cpu</span><span class="o">.</span><span class="n">idle_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">core_states</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu</span><span class="o">.</span><span class="n">frequency</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">cpu</span><span class="o">.</span><span class="n">idle_state</span> <span class="ow">in</span> <span class="n">freq_dependent_idle_states</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cpu</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">core_states</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cpu</span><span class="o">.</span><span class="n">idle_state</span><span class="p">,</span> <span class="n">cpu</span><span class="o">.</span><span class="n">frequency</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">core_states</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">core_states</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cpu</span><span class="o">.</span><span class="n">idle_state</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">system_state</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">core_states</span><span class="p">)</span></div>


<div class="viewcode-block" id="PowerStateTimeline"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateTimeline">[docs]</a><span class="k">class</span> <span class="nc">PowerStateTimeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">core_names</span><span class="p">,</span> <span class="n">idle_state_names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span> <span class="o">=</span> <span class="n">idle_state_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wfh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wfh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">core_names</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> CPU</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">core_names</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

<div class="viewcode-block" id="PowerStateTimeline.update"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateTimeline.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">core_states</span><span class="p">):</span>  <span class="c1"># NOQA</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idle_state</span><span class="p">,</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="n">core_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idle_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idle_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">[</span><span class="n">idle_state</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># frequency is not None</span>
                <span class="k">if</span> <span class="n">idle_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="n">UNKNOWN_FREQUENCY</span><span class="p">:</span>
                        <span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;Running (Unknown Hz)&#39;</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">idle_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="n">UNKNOWN_FREQUENCY</span><span class="p">:</span>
                        <span class="n">frequency</span> <span class="o">=</span> <span class="s1">&#39;Unknown Hz&#39;</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">[</span><span class="n">idle_state</span><span class="p">],</span>
                                                <span class="n">frequency</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="PowerStateTimeline.report"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateTimeline.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wfh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ParallelStats"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.ParallelStats">[docs]</a><span class="k">class</span> <span class="nc">ParallelStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_clusters</span><span class="p">,</span> <span class="n">use_ratios</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span> <span class="o">=</span> <span class="n">use_ratios</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">clust</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">clust</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">first_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_times</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_times</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<div class="viewcode-block" id="ParallelStats.update"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.ParallelStats.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">core_states</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span>
            <span class="n">active_cores</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_states</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">cluster_cores</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">clust_active_cores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_cores</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">active_cores</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parallel_times</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="n">clust_active_cores</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
                <span class="k">if</span> <span class="n">clust_active_cores</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_times</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># initial update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_states</span> <span class="o">=</span> <span class="n">core_states</span></div>

<div class="viewcode-block" id="ParallelStats.report"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.ParallelStats.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># NOQA</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">report</span> <span class="o">=</span> <span class="n">ParallelReport</span><span class="p">()</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_timestamp</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel_times</span><span class="p">):</span>
            <span class="n">running_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_times</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_times</span><span class="p">[</span><span class="n">cluster</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
                <span class="n">time_pc</span> <span class="o">=</span> <span class="n">time</span> <span class="o">/</span> <span class="n">total_time</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span><span class="p">:</span>
                    <span class="n">time_pc</span> <span class="o">*=</span> <span class="mi">100</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">running_time</span><span class="p">:</span>
                        <span class="n">running_time_pc</span> <span class="o">=</span> <span class="n">time</span> <span class="o">/</span> <span class="n">running_time</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">running_time_pc</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span><span class="p">:</span>
                        <span class="n">running_time_pc</span> <span class="o">*=</span> <span class="mi">100</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">running_time_pc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">or</span> <span class="mi">1</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;{{:.</span><span class="si">{}</span><span class="s1">f}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">report</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">cluster</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                            <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">),</span>
                            <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_pc</span><span class="p">),</span>
                            <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">running_time_pc</span><span class="p">),</span>
                            <span class="p">])</span>
        <span class="k">return</span> <span class="n">report</span></div></div>


<div class="viewcode-block" id="ParallelReport"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.ParallelReport">[docs]</a><span class="k">class</span> <span class="nc">ParallelReport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ParallelReport.add"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.ParallelReport.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParallelReport.write"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.ParallelReport.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wfh</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">wfh</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;number_of_cores&#39;</span><span class="p">,</span> <span class="s1">&#39;total_time&#39;</span><span class="p">,</span> <span class="s1">&#39;%time&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">unning_time&#39;</span><span class="p">])</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PowerStateStats"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateStats">[docs]</a><span class="k">class</span> <span class="nc">PowerStateStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">core_names</span><span class="p">,</span> <span class="n">idle_state_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ratios</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_names</span> <span class="o">=</span> <span class="n">core_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span> <span class="o">=</span> <span class="n">idle_state_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span> <span class="o">=</span> <span class="n">use_ratios</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<div class="viewcode-block" id="PowerStateStats.update"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateStats.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">core_states</span><span class="p">):</span>  <span class="c1"># NOQA</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span>
            <span class="k">for</span> <span class="n">cpu</span><span class="p">,</span> <span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_states</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">idle</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:07}</span><span class="s1">KHz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">freq</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">:</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{:07}</span><span class="s1">KHz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">[</span><span class="n">idle</span><span class="p">],</span> <span class="n">freq</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;idle</span><span class="si">{}</span><span class="s1">-</span><span class="si">{:07}</span><span class="s1">KHz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">idle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">:</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">[</span><span class="n">idle</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;idle</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;unkown&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="p">[</span><span class="n">cpu</span><span class="p">][</span><span class="n">state</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># initial update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_states</span> <span class="o">=</span> <span class="n">core_states</span></div>

<div class="viewcode-block" id="PowerStateStats.report"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateStats.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_timestamp</span>
        <span class="n">state_stats</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_names</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_states</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
                <span class="n">time_pc</span> <span class="o">=</span> <span class="n">time</span> <span class="o">/</span> <span class="n">total_time</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span><span class="p">:</span>
                    <span class="n">time_pc</span> <span class="o">*=</span> <span class="mi">100</span>
                <span class="n">state_stats</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_pc</span>

        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ratios</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">PowerStateStatsReport</span><span class="p">(</span><span class="n">state_stats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_names</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PowerStateStatsReport"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateStatsReport">[docs]</a><span class="k">class</span> <span class="nc">PowerStateStatsReport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_stats</span><span class="p">,</span> <span class="n">core_names</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_stats</span> <span class="o">=</span> <span class="n">state_stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_names</span> <span class="o">=</span> <span class="n">core_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>

<div class="viewcode-block" id="PowerStateStatsReport.write"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.PowerStateStatsReport.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wfh</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">wfh</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> CPU</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_names</span><span class="p">)]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_stats</span><span class="p">):</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_stats</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;{{:.</span><span class="si">{}</span><span class="s1">f}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">state</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                                           <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="CpuUtilisationTimeline"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.CpuUtilisationTimeline">[docs]</a><span class="k">class</span> <span class="nc">CpuUtilisationTimeline</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">core_names</span><span class="p">,</span> <span class="n">max_freq_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wfh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wfh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">core_names</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> CPU</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">core_names</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_freq_list</span> <span class="o">=</span> <span class="n">max_freq_list</span>

<div class="viewcode-block" id="CpuUtilisationTimeline.update"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.CpuUtilisationTimeline.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">core_states</span><span class="p">):</span>  <span class="c1"># NOQA</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">core</span><span class="p">,</span> <span class="p">[</span><span class="n">idle_state</span><span class="p">,</span> <span class="n">frequency</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">core_states</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idle_state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="n">UNKNOWN_FREQUENCY</span><span class="p">:</span>
                    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">idle_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_freq_list</span><span class="p">):</span>
                <span class="n">frequency</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_freq_list</span><span class="p">[</span><span class="n">core</span><span class="p">])</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to detect max frequency for this core. Cannot log utilisation value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="CpuUtilisationTimeline.report"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.CpuUtilisationTimeline.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wfh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="build_idle_domains"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.build_idle_domains">[docs]</a><span class="k">def</span> <span class="nf">build_idle_domains</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">,</span>   <span class="c1"># NOQA</span>
                       <span class="n">num_states</span><span class="p">,</span>
                       <span class="n">first_cluster_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">first_system_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of idle domain groups (one for each idle state). Each group is a</span>
<span class="sd">    list of domains, and a domain is a list of cpu ids for which that idle state is</span>
<span class="sd">    common. E.g.</span>

<span class="sd">        [[[0], [1], [2]], [[0, 1], [2]], [[0, 1, 2]]]</span>

<span class="sd">    This defines three idle states for a machine with three cores. The first idle state</span>
<span class="sd">    has three domains with one core in each domain; the second state has two domains,</span>
<span class="sd">    with cores 0 and 1 sharing one domain; the final state has only one domain shared</span>
<span class="sd">    by all cores.</span>

<span class="sd">    This mapping created based on the assumptions</span>

<span class="sd">    - The device is an SMP or a big.LITTLE-like system with cores in one or</span>
<span class="sd">      more clusters (for SMP systems, all cores are considered to be in a &quot;cluster&quot;).</span>
<span class="sd">    - Idle domain correspend to either individual cores, individual custers, or</span>
<span class="sd">      the compute subsystem as a whole.</span>
<span class="sd">    - Cluster states are always deeper (higher index) than core states, and</span>
<span class="sd">      system states are always deeper than cluster states.</span>

<span class="sd">    parameters:</span>

<span class="sd">        :core_clusters: a list indicating cluster &quot;ID&quot; of the corresponing core, e.g.</span>
<span class="sd">                        ``[0, 0, 1]`` represents a three-core machines with cores 0</span>
<span class="sd">                        and 1 on cluster 0, and core 2 on cluster 1.</span>
<span class="sd">        :num_states: total number of idle states on a device.</span>
<span class="sd">        :first_cluster_state: the ID of the first idle state shared by all cores in a</span>
<span class="sd">                              cluster</span>
<span class="sd">        :first_system_state: the ID of the first idle state shared by all cores.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">first_cluster_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_cluster_state</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxint</span>
    <span class="k">if</span> <span class="n">first_system_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_system_state</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxint</span>
    <span class="n">all_cpus</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">))</span>
    <span class="n">cluster_cpus</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">):</span>
        <span class="n">cluster_cpus</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
    <span class="n">cluster_domains</span> <span class="o">=</span> <span class="p">[</span><span class="n">cluster_cpus</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cluster_cpus</span><span class="p">)]</span>
    <span class="n">core_domains</span> <span class="o">=</span> <span class="p">[[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_cpus</span><span class="p">]</span>

    <span class="n">idle_state_domains</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">state_id</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">num_states</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state_id</span> <span class="o">&gt;=</span> <span class="n">first_system_state</span><span class="p">:</span>
            <span class="n">idle_state_domains</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">all_cpus</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">state_id</span> <span class="o">&gt;=</span> <span class="n">first_cluster_state</span><span class="p">:</span>
            <span class="n">idle_state_domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster_domains</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idle_state_domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core_domains</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">idle_state_domains</span></div>


<div class="viewcode-block" id="report_power_stats"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.report_power_stats">[docs]</a><span class="k">def</span> <span class="nf">report_power_stats</span><span class="p">(</span><span class="n">trace_file</span><span class="p">,</span> <span class="n">idle_state_names</span><span class="p">,</span> <span class="n">core_names</span><span class="p">,</span> <span class="n">core_clusters</span><span class="p">,</span>
                       <span class="n">num_idle_states</span><span class="p">,</span> <span class="n">first_cluster_state</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">,</span>
                       <span class="n">first_system_state</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">,</span> <span class="n">use_ratios</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">timeline_csv_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cpu_utilisation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">max_freq_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_marker_handling</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
    <span class="c1"># pylint: disable=too-many-locals,too-many-branches</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">TraceCmdTrace</span><span class="p">(</span><span class="n">trace_file</span><span class="p">,</span>
                          <span class="n">filter_markers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpu_idle&#39;</span><span class="p">,</span> <span class="s1">&#39;cpu_frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">])</span>

    <span class="n">wait_for_start_marker</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">start_marker_handling</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trace</span><span class="o">.</span><span class="n">has_start_marker</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span><span class="s2">&quot;Start marker was not found in the trace&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">start_marker_handling</span> <span class="o">==</span> <span class="s2">&quot;try&quot;</span><span class="p">:</span>
        <span class="n">wait_for_start_marker</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">has_start_marker</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wait_for_start_marker</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Did not see a START marker in the trace, &quot;</span>
                           <span class="s2">&quot;state residency and parallelism statistics may be inaccurate.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">start_marker_handling</span> <span class="o">==</span> <span class="s2">&quot;ignore&quot;</span><span class="p">:</span>
        <span class="n">wait_for_start_marker</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">ps_processor</span> <span class="o">=</span> <span class="n">PowerStateProcessor</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">,</span>
                                       <span class="n">num_idle_states</span><span class="o">=</span><span class="n">num_idle_states</span><span class="p">,</span>
                                       <span class="n">first_cluster_state</span><span class="o">=</span><span class="n">first_cluster_state</span><span class="p">,</span>
                                       <span class="n">first_system_state</span><span class="o">=</span><span class="n">first_system_state</span><span class="p">,</span>
                                       <span class="n">wait_for_start_marker</span><span class="o">=</span><span class="n">wait_for_start_marker</span><span class="p">)</span>
    <span class="n">reporters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ParallelStats</span><span class="p">(</span><span class="n">core_clusters</span><span class="p">,</span> <span class="n">use_ratios</span><span class="p">),</span>
        <span class="n">PowerStateStats</span><span class="p">(</span><span class="n">core_names</span><span class="p">,</span> <span class="n">idle_state_names</span><span class="p">,</span> <span class="n">use_ratios</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">timeline_csv_file</span><span class="p">:</span>
        <span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PowerStateTimeline</span><span class="p">(</span><span class="n">timeline_csv_file</span><span class="p">,</span>
                                            <span class="n">core_names</span><span class="p">,</span> <span class="n">idle_state_names</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">cpu_utilisation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_freq_list</span><span class="p">:</span>
            <span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CpuUtilisationTimeline</span><span class="p">(</span><span class="n">cpu_utilisation</span><span class="p">,</span> <span class="n">core_names</span><span class="p">,</span> <span class="n">max_freq_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Maximum frequencies not found. Cannot normalise. Skipping CPU Utilisation Timeline&#39;</span><span class="p">)</span>

    <span class="n">event_stream</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">transition_stream</span> <span class="o">=</span> <span class="n">stream_cpu_power_transitions</span><span class="p">(</span><span class="n">event_stream</span><span class="p">)</span>
    <span class="n">power_state_stream</span> <span class="o">=</span> <span class="n">ps_processor</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">transition_stream</span><span class="p">)</span>
    <span class="n">core_state_stream</span> <span class="o">=</span> <span class="n">gather_core_states</span><span class="p">(</span><span class="n">power_state_stream</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">core_state_stream</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">reporter</span> <span class="ow">in</span> <span class="n">reporters</span><span class="p">:</span>
            <span class="n">reporter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">states</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ps_processor</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;There were errors while processing trace:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ps_processor</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">reporter</span> <span class="ow">in</span> <span class="n">reporters</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">reporter</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
        <span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reports</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_arguments</span><span class="p">()</span>

    <span class="n">reports</span> <span class="o">=</span> <span class="n">report_power_stats</span><span class="p">(</span>
        <span class="n">trace_file</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">infile</span><span class="p">,</span>
        <span class="n">idle_state_names</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">,</span>
        <span class="n">core_names</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">core_names</span><span class="p">,</span>
        <span class="n">core_clusters</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">core_clusters</span><span class="p">,</span>
        <span class="n">num_idle_states</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span><span class="p">,</span>
        <span class="n">first_cluster_state</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">first_cluster_state</span><span class="p">,</span>
        <span class="n">first_system_state</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">first_system_state</span><span class="p">,</span>
        <span class="n">use_ratios</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ratios</span><span class="p">,</span>
        <span class="n">timeline_csv_file</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">timeline_file</span><span class="p">,</span>
        <span class="n">cpu_utilisation</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cpu_utilisation</span><span class="p">,</span>
        <span class="n">max_freq_list</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_freq_list</span><span class="p">,</span>
        <span class="n">start_marker_handling</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">start_marker_handling</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parallel_report</span> <span class="o">=</span> <span class="n">reports</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">powerstate_report</span> <span class="o">=</span> <span class="n">reports</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">parallel_report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;parallel.csv&#39;</span><span class="p">))</span>
    <span class="n">powerstate_report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;cpustate.csv&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="SplitListAction"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.SplitListAction">[docs]</a><span class="k">class</span> <span class="nc">SplitListAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;nargs not allowed&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SplitListAction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">option_strings</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span></div>


<div class="viewcode-block" id="parse_arguments"><a class="viewcode-back" href="../../../api/wlauto.utils.html#wlauto.utils.power.parse_arguments">[docs]</a><span class="k">def</span> <span class="nf">parse_arguments</span><span class="p">():</span>  <span class="c1"># NOQA</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                     Produce CPU power activity statistics reports from</span>
<span class="s2">                                     power trace.</span>
<span class="s2">                                     &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;infile&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;TRACEFILE&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        Path to the trace file to parse. This must be in the format generated</span>
<span class="s1">                        by &quot;trace-cmd report&quot; command.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--output-directory&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        Output directory where reports will be placed.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--core-names&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SplitListAction</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        Comma-separated list of core names for the device on which the trace</span>
<span class="s1">                        was collected.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span> <span class="s1">&#39;--core-clusters&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SplitListAction</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        Comma-separated list of core cluster IDs for the device on which the</span>
<span class="s1">                        trace was collected. If not specified, this will be generated from</span>
<span class="s1">                        core names on the assumption that all cores with the same name are on the</span>
<span class="s1">                        same cluster.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--idle-state-names&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SplitListAction</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        Comma-separated list of idle state names. The number of names must match</span>
<span class="s1">                        --num-idle-states if that was explicitly specified.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--num-idle-states&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        number of  idle states on the device</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--first-cluster-state&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        ID of the first cluster state. Must be &lt; --num-idle-states.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--first-system-state&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        ID of the first system state. Must be &lt; --numb-idle-states, and</span>
<span class="s1">                        &gt; --first-cluster-state.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;--ratios&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        By default proportional values will be reported as percentages, if this</span>
<span class="s1">                        flag is enabled, they will be reported as ratios instead.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--timeline-file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        A timeline of core power states will be written to the specified file in</span>
<span class="s1">                        CSV format.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--cpu-utilisation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        A timeline of cpu(s) utilisation will be written to the specified file in</span>
<span class="s1">                        CSV format.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--max-freq-list&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">SplitListAction</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        Comma-separated list of core maximum frequencies for the device on which</span>
<span class="s1">                        the trace was collected.</span>
<span class="s1">                        Only required if --cpu-utilisation is set.</span>
<span class="s1">                        This is used to normalise the frequencies to obtain percentage utilisation.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-M&#39;</span><span class="p">,</span> <span class="s1">&#39;--start-marker-handling&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;HANDLING&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;try&quot;</span><span class="p">,</span>
                        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;try&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        The trace-cmd instrument inserts a marker into the trace to indicate the beginning</span>
<span class="s1">                        of workload execution. In some cases, this marker may be missing in the final</span>
<span class="s1">                        output (e.g. due to trace buffer overrun). This parameter specifies how a missing</span>
<span class="s1">                        start marker will be handled:</span>

<span class="s1">                         ignore:  The start marker will be ignored. All events in the trace will be used.</span>
<span class="s1">                         error:   An error will be raised if the start marker is not found in the trace.</span>
<span class="s1">                         try:     If the start marker is not found, all events in the trace will be used.</span>
<span class="s1">                        &#39;&#39;&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">core_names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;core names must be specified using -c or --core-names&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">core_clusters</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;core clusters not specified, inferring from core names&#39;</span><span class="p">)</span>
        <span class="n">core_cluster_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">core_clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_cluster</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">core_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">core_cluster_map</span><span class="p">:</span>
                <span class="n">core_cluster_map</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_cluster</span>
                <span class="n">current_cluster</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">core_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core_cluster_map</span><span class="p">[</span><span class="n">cn</span><span class="p">])</span>
        <span class="n">args</span><span class="o">.</span><span class="n">core_clusters</span> <span class="o">=</span> <span class="n">core_clusters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;idle</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">idle_state_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of idle state names does not match --num-idle-states&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either --num-idle-states or --idle-state-names must be specified&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">first_cluster_state</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">core_clusters</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">first_system_state</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;First cluster idle state not specified; state previous to first system state&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">first_cluster_state</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first_system_state</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;First cluster idle state not specified; assuming last available state&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">first_cluster_state</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">num_idle_states</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">args</span></div>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Workload Automation 2.6.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013, ARM Ltd.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>